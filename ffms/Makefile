############################################################
#
# ffsrv Makefile
# Generated by amyznikov Mar 17, 2016
#   from 'linux-gcc-executable' template
#
############################################################

SHELL = /bin/bash

TARGET = ffms

all: $(TARGET)


cross   =
sysroot =
DESTDIR =
prefix  = /usr/local
bindir  = $(prefix)/bin
incdir  = $(prefix)/include
libdir  = $(prefix)/lib

INCLUDES+= -I. -I../src
SOURCES = $(wildcard *.c)
HEADERS = $(wildcard *.h)
MODULES = $(foreach s,$(SOURCES),$(addsuffix .o,$(basename $(s))))


use_local_ffmpeg_libs = 1

# order is important
FFLIBS := avdevice avfilter avformat avcodec swscale swresample avresample postproc avutil 

ifeq ($(strip $(use_local_ffmpeg_libs)),1)
PKG_CONFIG = PKG_CONFIG_PATH=/usr/local/lib/pkgconfig pkg-config
FFMPEG_LIBS := $(addprefix /usr/local/lib/lib,$(addsuffix .a,$(FFLIBS))) \
   $(filter-out $(addprefix -l,$(FFLIBS)),$(sort $(shell $(PKG_CONFIG) --static --libs $(addprefix lib,$(FFLIBS)))))
FFMPEG_CFLAGS := $(sort $(shell $(PKG_CONFIG) --static --cflags $(addprefix lib,$(FFLIBS))))
else
PKG_CONFIG = pkg-config
FFMPEG_LIBS := $(shell $(PKG_CONFIG) --libs  $(addprefix lib,$(FFLIBS)) )
FFMPEG_CFLAGS := $(shell $(PKG_CONFIG) --cflags  $(addprefix lib,$(FFLIBS)) )
endif




# C preprocessor flags
CPPFLAGS=$(DEFINES) $(INCLUDES)

# C Compiler and flags
CC = $(cross)gcc
CFLAGS= -Wall -Wextra -g3 -O3

# Loader Flags And Libraries
LD=$(CC)
LDFLAGS = $(CFLAGS)

# STRIP = $(cross)strip --strip-all
STRIP = @echo "don't strip "

LIBFFSRV = ../src/libffsrv.a 

LDLIBS +=  $(FFMPEG_LIBS) -lpcl -lrt -lpthread


#########################################


$(MODULES): $(HEADERS) Makefile
$(TARGET) : $(LIBFFSRV) $(MODULES) Makefile
	$(LD) $(LDFLAGS) $(MODULES) $(LIBFFSRV) $(LDLIBS) -o $@

clean:
	$(RM) $(MODULES)

distclean: clean
	$(RM) $(TARGET)

install: $(TARGET) $(DESTDIR)/$(bindir)
	cp $(TARGET) $(DESTDIR)/$(bindir) && $(STRIP) $(DESTDIR)/$(bindir)/$(TARGET)

uninstall:
	$(RM) $(DESTDIR)/$(bindir)/$(TARGET)


$(DESTDIR)/$(bindir):
	mkdir -p $@
